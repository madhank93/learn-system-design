upstream backend {
    hash $cookie_session_id consistent;
    zone backend_zone 64k;
    server server1:8080;
    server server2:8080;
    server server3:8080;
}

server {
    listen 80;
    location / {
        # Generate session cookie if missing
        if ($cookie_session_id = "") {
            add_header Set-Cookie "session_id=$request_id; Path=/; HttpOnly";
        }

        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Session-ID $cookie_session_id;
        proxy_set_header Cookie $http_cookie;
    }
}
